<!DOCTYPE html>
<html lang="tr">
<head>
    <title>PRO LISTE V5 - FIREBASE FIX</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --danger: #ef4444; --text: #f8fafc; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .top-fixed-bar { background: var(--card); padding: 10px; border-bottom: 2px solid var(--accent); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        #total-value { font-size: 30px; font-weight: 900; color: var(--accent); }
        .container { display: grid; grid-template-columns: repeat(4, 1fr); grid-gap: 6px; padding: 8px; overflow-y: auto; flex-grow: 1; align-content: start; }
        .item-card { background: var(--success); border-radius: 6px; height: 60px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-weight: 900; font-size: 14px; position: relative; }
        .item-card.has-price { background: var(--danger); }
        .item-price-tag { font-size: 10px; margin-top: 2px; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--card); width: 90%; padding: 20px; border-radius: 15px; border: 2px solid var(--accent); }
        .side-menu { position: fixed; top: 0; left: -100%; width: 75%; height: 100%; background: var(--card); z-index: 2500; transition: 0.3s; padding: 20px; box-sizing: border-box; }
        .side-menu.open { left: 0; }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #000; color: #fff; border: 1px solid var(--accent); box-sizing: border-box; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; border: none; color: #fff; font-weight: bold; }
    </style>
</head>
<body>

<div id="mainApp">
    <div class="top-fixed-bar">
        <div class="header-row">
            <div onclick="openMenu()" style="font-size:30px; cursor:pointer">â˜°</div>
            <div id="total-value">0.00</div>
            <div>
                <button class="circle-btn" style="background:var(--success)" onclick="openAdd()">+</button>
            </div>
        </div>
    </div>
    <div class="container" id="mainGrid"></div>
</div>

<div id="sideMenu" class="side-menu">
    <h2>MENÃœ</h2>
    <button onclick="newList()" style="width:100%; padding:15px; background:var(--accent); border:none; color:#fff; font-weight:bold">YENÄ° LÄ°STE</button>
    <h3>GEÃ‡MÄ°Åž</h3>
    <div id="historyBox"></div>
</div>

<div id="gModal" class="modal">
    <div class="modal-content" id="mContent"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA9whlWMrlyF6GMnWBK7SQA76qNFpO7RkQ",
    authDomain: "market-listesi-d9338.firebaseapp.com",
    projectId: "market-listesi-d9338",
    storageBucket: "market-listesi-d9338.firebasestorage.app",
    messagingSenderId: "91497340883",
    appId: "1:91497340883:web:6e9280b4a70d0a6f38d926",
    databaseURL: "https://market-listesi-d9338-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentList = [];
let history = [];
let isInitialLoad = true; // ðŸ”¥ SÄ°LÄ°NMEYÄ° Ã–NLEYEN KÄ°LÄ°T

const $ = id => document.getElementById(id);

// ðŸ”¹ VERÄ°LERÄ° Ã‡EK
db.ref('products').on('value', snap => {
    currentList = snap.val() || [];
    isInitialLoad = false; // Veri geldi, artÄ±k yazma yapÄ±labilir
    renderUI();
});

db.ref('history').on('value', snap => {
    history = snap.val() || [];
    renderHistory();
});

function sync() {
    if(isInitialLoad) return; // Veri Ã§ekilmeden asla Ã¼zerine yazma!
    db.ref('products').set(currentList);
    db.ref('history').set(history);
}

function renderUI() {
    const grid = $('mainGrid');
    grid.innerHTML = '';
    let total = 0;
    currentList.forEach((item, i) => {
        const card = document.createElement('div');
        card.className = `item-card ${item.price > 0 ? 'has-price' : ''}`;
        card.innerHTML = `<div>${item.name}</div>${item.price > 0 ? `<div class="item-price-tag">${item.price} TL</div>` : ''}`;
        card.onclick = () => openEdit(i);
        grid.appendChild(card);
        if(item.price > 0) total += parseFloat(item.price);
    });
    $('total-value').innerText = total.toFixed(2);
}

function openAdd() {
    $('mContent').innerHTML = `<h3>EKLE</h3><input id="nIn" placeholder="ÃœrÃ¼n..."><button onclick="saveNew()" style="width:100%; padding:10px; background:var(--success); border:none; color:#fff">EKLE</button>`;
    $('gModal').style.display = 'flex';
}

function saveNew() {
    const val = $('nIn').value.toUpperCase();
    if(val) { currentList.push({name: val, price: 0}); sync(); closeM(); }
}

function openEdit(i) {
    const item = currentList[i];
    $('mContent').innerHTML = `<h3>${item.name}</h3><input id="pIn" type="number" step="0.01" value="${item.price || ''}" placeholder="Fiyat..."><button onclick="saveEdit(${i})" style="width:100%; padding:10px; background:var(--accent); border:none; color:#fff">KAYDET</button><br><br><button onclick="deleteItem(${i})" style="width:100%; background:var(--danger); border:none; color:#fff; padding:5px">SÄ°L</button>`;
    $('gModal').style.display = 'flex';
}

function saveEdit(i) {
    currentList[i].price = $('pIn').value || 0;
    sync(); closeM();
}

function deleteItem(i) {
    currentList.splice(i, 1);
    sync(); closeM();
}

function newList() {
    if(currentList.length > 0) {
        history.unshift({id: Date.now(), name: "LÄ°STE " + (history.length + 1), data: [...currentList]});
    }
    currentList = [];
    sync();
    $('sideMenu').classList.remove('open');
}

function renderHistory() {
    const box = $('historyBox');
    box.innerHTML = history.map((h, i) => `<div onclick="loadHist(${i})" style="padding:10px; border-bottom:1px solid #444">${h.name} (${h.data ? h.data.length : 0} ÃœrÃ¼n)</div>`).join('');
}

function loadHist(i) {
    currentList = [...history[i].data];
    sync();
    $('sideMenu').classList.remove('open');
}

function openMenu() { $('sideMenu').classList.add('open'); }
function closeM() { $('gModal').style.display = 'none'; }
window.onclick = (e) => { if(e.target == $('gModal')) closeM(); if(e.target == $('sideMenu')) $('sideMenu').classList.remove('open'); }
</script>
</body>
</html>
