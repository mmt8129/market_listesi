<!DOCTYPE html>
<html lang="tr">
<head>
    <title>PRO LISTE V5</title>
<link rel="manifest" href="manifest.json">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --success: #22c55e;
            --danger: #ef4444;
            --text: #f8fafc;
            --shadow: 2px 2px 3px rgba(0,0,0,1);
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* BLUR KONTROLÃœ */
        .blur-target { transition: filter 0.3s ease; }
        body.modal-open .blur-target { filter: blur(8px); pointer-events: none; }

        /* ÃœST PANEL */
        .top-fixed-bar { background: var(--card); padding: 10px; border-bottom: 2px solid var(--accent); z-index: 100; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .menu-icon { font-size: 35px; cursor: pointer; color: var(--accent); }
        .total-display { text-align: center; flex-grow: 1; }
        #total-value { font-size: 30px; font-weight: 900; color: var(--accent); }
        .item-count-badge { font-size: 11px; font-weight: bold; opacity: 0.9; }

        .action-btns { display: flex; gap: 5px; }
        .circle-btn { width: 42px; height: 42px; border-radius: 50%; border: none; font-size: 20px; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; }
        .btn-plus { background: var(--success); }
        .btn-minus { background: var(--danger); }
        .btn-bulk { background: var(--accent); font-size: 14px; }

        .stats-row { display: flex; justify-content: space-around; margin-top: 12px; font-size: 13px; font-weight: 800; }
        .stat-box { padding: 5px 10px; background: rgba(0,0,0,0.2); border-radius: 5px; cursor: pointer; }

        /* ANA LÄ°STE */
        .container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-gap: 6px;
            padding: 8px;
            overflow-y: auto;
            flex-grow: 1;
            align-content: start;
        }

        .item-card {
            background: var(--success);
            border-radius: 6px;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .item-card.has-price { background: var(--danger); }
        .item-text { font-weight: 900; text-transform: uppercase; text-shadow: var(--shadow); text-align: center; width: 100%; line-height: 1; }
        .item-price-tag { font-size: 10px; margin-top: 3px; font-weight: bold; text-shadow: var(--shadow); }

        /* SÄ°LME MODU */
        .delete-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; border-radius: 6px; }
        .item-card.selected .delete-overlay { display: flex; }
        .item-card.selected .delete-overlay::after { content: 'X'; color: #fff; font-size: 40px; font-weight: 900; }

        /* MODALLAR */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: var(--card); width: 90%; padding: 20px; border-radius: 15px; border: 2px solid var(--accent); box-sizing: border-box; max-height: 80vh; display: flex; flex-direction: column; }
        
        .scroll-area { overflow-y: auto; flex-grow: 1; margin: 10px 0; }
        .list-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #334155; font-weight: bold; text-transform: uppercase; }
        .fixed-footer-banner { border-top: 3px solid var(--accent); padding-top: 10px; text-align: center; font-size: 20px; font-weight: 900; color: var(--success); }

        input, textarea { width: 100%; padding: 12px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box; text-transform: uppercase; font-weight: bold; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .modal-btns button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 900; color: white; }
        .btn-ok { background: var(--accent); }
        .btn-cancel { background: #475569; }

        /* YAN MENÃœ */
        .side-menu { position: fixed; top: 0; left: -100%; width: 50%; height: 100%; background: var(--card); z-index: 2500; transition: 0.4s; padding: 25px; box-shadow: 10px 0 20px rgba(0,0,0,0.6); display: flex; flex-direction: column; }
        .side-menu.open { left: 0; }
        .menu-btn { width: 100%; background: #334155; color: white; border: none; padding: 15px; border-radius: 10px; margin-bottom: 12px; font-weight: 800; text-align: left; }
        .history-list { margin-top: 10px; border: 2px solid #334155; flex-grow: 1; overflow-y: auto; border-radius: 10px; background: rgba(0,0,0,0.2); }
        .history-item { padding: 15px; border-bottom: 1px solid #334155; font-size: 14px; display: flex; justify-content: space-between; font-weight: bold; }
        .history-item.active-list { border: 2px solid var(--accent); background: rgba(56, 189, 248, 0.1); border-radius: 8px; }

        .floating-confirm { position: fixed; bottom: 30px; left: 0; width: 100%; display: none; justify-content: center; gap: 20px; z-index: 1500; }
    </style>
</head>
<body>

<div class="blur-target" id="mainWrapper">
    <div class="top-fixed-bar">
        <div class="header-row">
            <div class="menu-icon" id="menuBtn">â˜°</div>
            <div class="total-display">
                <div id="total-value">0.00</div>
                <div class="item-count-badge">TOPLAM ÃœRÃœN: <span id="total-items-count">0</span></div>
            </div>
            <div class="action-btns">
                <button class="circle-btn btn-bulk" id="mBulkList">+++</button>
                <button class="circle-btn btn-plus" id="addQuick">+</button>
                <button class="circle-btn btn-minus" id="delQuick">-</button>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-box" id="btnShowTaken">ALINANLAR: <span id="count-taken">0</span></div>
            <div class="stat-box" id="btnShowTodo">ALINACAKLAR: <span id="count-todo">0</span></div>
        </div>
    </div>
    <div class="container" id="mainGrid"></div>
</div>

<div class="side-menu" id="sideMenu">
    <h2 style="color:var(--accent)">Ä°ÅžLEMLER</h2>
    <button class="menu-btn" id="mNewList">ðŸ“„ YENÄ° LÄ°STE OLUÅžTUR</button>
    <h3 style="margin-top:15px; font-size: 14px; opacity: 0.6;">GEÃ‡MÄ°Åž LÄ°STELER</h3>
    <div class="history-list" id="historyBox"></div>
</div>

<div class="floating-confirm" id="deleteControls">
    <button class="circle-btn" id="confirmDel" style="background:var(--success); width:60px; height:60px;">âœ“</button>
    <button class="circle-btn" id="cancelDel" style="background:var(--danger); width:60px; height:60px;">X</button>
</div>

<div id="gModal" class="modal">
    <div class="modal-content" id="mContent"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
    
<script>

const firebaseConfig = {
  apiKey: "AIzaSyA9whlWMrlyF6GMnWBK7SQA76qNFpO7RkQ",
  authDomain: "market-listesi-d9338.firebaseapp.com",
  projectId: "market-listesi-d9338",
  storageBucket: "market-listesi-d9338.firebasestorage.app",
  messagingSenderId: "91497340883",
  appId: "1:91497340883:web:6e9280b4a70d0a6f38d926",
  databaseURL: "https://market-listesi-d9338-default-rtdb.firebaseio.com"
};

// Firebase'i BaÅŸlat
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
    
    let currentList = [];

// Firebase'den verileri anlÄ±k Ã§ek
db.ref('products').on('value', (snapshot) => {
    const data = snapshot.val();
    currentList = data ? Object.values(data) : [];
    render(); // Veri gelince ekranÄ± tazele
});
    
    let currentListId = Date.now();
    let currentListName = "YENÄ° LÄ°STE";
   let history = [];
    let deleteMode = false;
    let selectedForDelete = new Set();
    let pressTimer;
    let isLongPress = false;

    const $ = id => document.getElementById(id);

    function toggleBlur(show) {
        if(show) document.body.classList.add('modal-open');
        else document.body.classList.remove('modal-open');
    }

function saveData() {
    db.ref('products').set(currentList);
    db.ref('history').set(history);
}
    
    function render() {
        const grid = $('mainGrid');
        grid.innerHTML = '';
        let total = 0, taken = 0, todo = 0;

        currentList.forEach((item, i) => {
            const card = document.createElement('div');
            card.className = `item-card ${item.price > 0 ? 'has-price' : ''}`;
            let fSize = item.name.length > 10 ? "11px" : (item.name.length > 6 ? "14px" : "16px");
            card.innerHTML = `<div class="item-text" style="font-size:${fSize}">${item.name}</div>${item.price > 0 ? `<div class="item-price-tag">${item.price} TL</div>` : ''}<div class="delete-overlay"></div>`;

            card.onmousedown = card.ontouchstart = (e) => {
                isLongPress = false;
                pressTimer = setTimeout(() => {
                    isLongPress = true;
                    if(navigator.vibrate) navigator.vibrate(50);
                    openEditModal(i);
                }, 600);
            };
            card.onmouseup = card.ontouchend = () => clearTimeout(pressTimer);
            card.onclick = () => {
                if(isLongPress) return;
                if(deleteMode) {
                    if(selectedForDelete.has(i)) { selectedForDelete.delete(i); card.classList.remove('selected'); }
                    else { selectedForDelete.add(i); card.classList.add('selected'); }
                } else { openEditModal(i); }
            };
            grid.appendChild(card);
            if(item.price > 0) { total += parseFloat(item.price); taken++; } else { todo++; }
        });

        $('total-value').innerText = total.toFixed(2);
        $('total-items-count').innerText = currentList.length;
        $('count-taken').innerText = taken;
        $('count-todo').innerText = todo;
        
        const histIdx = history.findIndex(x => x.id === currentListId);
        if(histIdx > -1) {
            history[histIdx].data = [...currentList];
            localStorage.setItem('v5_history', JSON.stringify(history));
            updateHistoryUI();
        }
        localStorage.setItem('v5_current', JSON.stringify({id: currentListId, name: currentListName, data: currentList}));
    }

    function openAddModal() {
        toggleBlur(true);
        $('mContent').innerHTML = `<h3>YENÄ° ÃœRÃœN</h3><input type="text" id="inName" placeholder="ÃœRÃœN ADI..." autofocus><div class="modal-btns"><button class="btn-ok" id="btnSaveAdd">EKLE</button><button class="btn-cancel" id="btnCloseM">Ä°PTAL</button></div>`;
        $('gModal').style.display = 'flex';
        setTimeout(() => { $('inName').focus(); }, 150);
        $('btnSaveAdd').onclick = () => { const n = $('inName').value.trim().toUpperCase(); if(n) { currentList.push({name: n, price: 0}); render(); } closeGModal(); };
        $('btnCloseM').onclick = closeGModal;
    }

    function openEditModal(i) {
        toggleBlur(true);
        const item = currentList[i];
        $('mContent').innerHTML = `<h3>${item.name}</h3><input type="text" id="edName" value="${item.name}"><input type="number" id="edPrice" placeholder="FÄ°YAT" value="${item.price || ''}"><div class="modal-btns"><button class="btn-ok" id="btnSaveEdit">TAMAM</button><button class="btn-cancel" id="btnCloseE">Ä°PTAL</button></div>`;
        $('gModal').style.display = 'flex';
         setTimeout(() => { $('inName').focus(); }, 150);
        $('btnSaveEdit').onclick = () => { currentList[i].name = $('edName').value.trim().toUpperCase(); currentList[i].price = $('edPrice').value || 0; render(); closeGModal(); };
        $('btnCloseE').onclick = closeGModal;
    }

    function openStatusModal(type) {
        toggleBlur(true);
        const filtered = currentList.filter(x => type === 'taken' ? x.price > 0 : x.price == 0);
        let listHtml = filtered.map(x => `<div class="list-row"><span>${x.name}</span><span>${x.price > 0 ? x.price + ' TL' : ''}</span></div>`).join('');
        $('mContent').innerHTML = `<h3>${type === 'taken' ? 'ALINANLAR' : 'ALINACAKLAR'}</h3><div class="scroll-area">${listHtml || 'BOÅž'}</div><div class="fixed-footer-banner">TOPLAM: ${filtered.reduce((a, b) => a + parseFloat(b.price || 0), 0).toFixed(2)} TL</div><button class="btn-cancel" style="width:100%; margin-top:10px;" id="btnCloseS">KAPAT</button>`;
        $('gModal').style.display = 'flex';
        $('btnCloseS').onclick = closeGModal;
    }

    function openBulkModal() {
        toggleBlur(true);
        const currentNames = currentList.map(x => x.name).join('\n');
        $('mContent').innerHTML = `<h3>LÄ°STE YAP</h3><textarea id="bulkData" rows="10">${currentNames}</textarea><div class="modal-btns"><button class="btn-ok" id="btnSaveBulk">GÃœNCELLE</button><button class="btn-cancel" id="btnCloseB">Ä°PTAL</button></div>`;
        $('gModal').style.display = 'flex';
        $('btnSaveBulk').onclick = () => {
            const lines = $('bulkData').value.split('\n');
            let newList = [];
            lines.forEach(line => { const n = line.trim().toUpperCase(); if(n) { const ex = currentList.find(x => x.name === n); newList.push(ex ? ex : {name: n, price: 0}); } });
            currentList = newList; render(); closeGModal();
        };
        $('btnCloseB').onclick = closeGModal;
    }

    function closeGModal() { $('gModal').style.display='none'; toggleBlur(false); }

    function updateHistoryUI() {
        const box = $('historyBox');
        box.innerHTML = history.map((h, i) => `<div class="history-item ${h.id === currentListId ? 'active-list' : ''}" id="histItem-${i}"><span>${h.name}</span><span style="color:var(--accent)">${h.data.length} ÃœRÃœN</span></div>`).join('');
        history.forEach((h, i) => {
            const el = $(`histItem-${i}`);
            el.onmousedown = el.ontouchstart = () => { isLongPress = false; pressTimer = setTimeout(() => { isLongPress = true; if(navigator.vibrate) navigator.vibrate(50); closeSideMenu(); openHistAction(i); }, 800); };
            el.onmouseup = el.ontouchend = () => clearTimeout(pressTimer);
            el.onclick = () => { if(isLongPress) return; currentListId = h.id; currentListName = h.name; currentList = [...h.data]; render(); updateHistoryUI(); closeSideMenu(); };
        });
    }

    function openHistAction(i) {
        toggleBlur(true);
        $('mContent').innerHTML = `<h3>LÄ°STE AYARI</h3><input type="text" id="hNewName" value="${history[i].name}"><div class="modal-btns"><button class="btn-ok" id="btnRenH">ADLANDIR</button><button class="btn-cancel" style="background:var(--danger)" id="btnOpenDelH">SÄ°L</button></div><button class="btn-cancel" style="width:100%; margin-top:10px;" id="btnCloseH">KAPAT</button>`;
        $('gModal').style.display = 'flex';
        $('btnRenH').onclick = () => { history[i].name = $('hNewName').value.toUpperCase(); if(history[i].id === currentListId) currentListName = history[i].name; localStorage.setItem('v5_history', JSON.stringify(history)); updateHistoryUI(); render(); closeGModal(); };
        $('btnCloseH').onclick = closeGModal;
        $('btnOpenDelH').onclick = () => {
            $('mContent').innerHTML = `<h3>SÄ°LÄ°NSÄ°N MÄ°?</h3><p style="text-align:center;">"${history[i].name}" SÄ°LÄ°NECEK.</p><div class="modal-btns"><button class="btn-ok" style="background:var(--danger)" id="btnConfirmDelH">SÄ°L</button><button class="btn-cancel" id="btnAbortH">Ä°PTAL</button></div>`;
            $('btnConfirmDelH').onclick = () => { const deletedId = history[i].id; history.splice(i, 1); localStorage.setItem('v5_history', JSON.stringify(history)); if(deletedId === currentListId) { currentList = []; currentListId = Date.now(); currentListName = "YENÄ° LÄ°STE"; } updateHistoryUI(); render(); closeGModal(); };
            $('btnAbortH').onclick = closeGModal;
        };
    }

    $('menuBtn').onclick = () => { $('sideMenu').classList.add('open'); toggleBlur(true); };
    function closeSideMenu() { $('sideMenu').classList.remove('open'); toggleBlur(false); }
    
    $('addQuick').onclick = openAddModal;
    $('mBulkList').onclick = openBulkModal;
    $('delQuick').onclick = () => { deleteMode = true; selectedForDelete.clear(); $('deleteControls').style.display = 'flex'; $('mainWrapper').style.opacity = "0.5"; };
    $('cancelDel').onclick = () => { deleteMode = false; $('deleteControls').style.display = 'none'; $('mainWrapper').style.opacity = "1"; render(); };
    $('confirmDel').onclick = () => { currentList = currentList.filter((_, i) => !selectedForDelete.has(i)); deleteMode = false; $('deleteControls').style.display = 'none'; $('mainWrapper').style.opacity = "1"; render(); };
    
    $('mNewList').onclick = () => {
        const newId = Date.now();
        const newName = "LÄ°STE " + (history.length + 1);
        history.unshift({id: newId, name: newName, data: []});
        currentList = []; currentListId = newId; currentListName = newName;
        localStorage.setItem('v5_history', JSON.stringify(history)); 
        render(); updateHistoryUI(); closeSideMenu();
    };

    $('btnShowTaken').onclick = () => openStatusModal('taken');
    $('btnShowTodo').onclick = () => openStatusModal('todo');

    window.onclick = (e) => {
        if(!e.target.closest('#sideMenu') && !e.target.closest('.menu-icon') && $('sideMenu').classList.contains('open')) { closeSideMenu(); }
    };

    window.onload = () => {
        const saved = localStorage.getItem('v5_current');
        if(saved) {
            const parsed = JSON.parse(saved);
            currentList = parsed.data || [];
            currentListId = parsed.id || Date.now();
            currentListName = parsed.name || "YENÄ° LÄ°STE";
        }
        updateHistoryUI(); render();
    };

db.ref('products').on('value', (snapshot) => {
    currentList = snapshot.val() || [];
    render();
});

db.ref('history').on('value', (snapshot) => {
    history = snapshot.val() || [];
});
    
</script>
// Firebase'den verileri anlÄ±k Ã§ekme ve ekranÄ± basma
db.ref('products').on('value', (snapshot) => {
    const data = snapshot.val();
    currentList = data || []; 
    console.log("Veri geldi:", currentList); // Kontrol iÃ§in
    render(); 
});

function saveData() {
    db.ref('products').set(currentList);
}
    <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js');
  }

// Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda ve veri her deÄŸiÅŸtiÄŸinde listeyi tazeler
db.ref('products').on('value', (snapshot) => {
    const data = snapshot.val();
    currentList = data || []; // Veri varsa al, yoksa boÅŸ liste yap
    render(); // EkranÄ± gÃ¼ncelle
});

db.ref('products').on('value', (snapshot) => {
    currentList = snapshot.val() || [];
    render();
});

db.ref('history').on('value', (snapshot) => {
    history = snapshot.val() || [];
});
        
</script>
    
</body>
</html>
