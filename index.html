<!DOCTYPE html>
<html lang="tr">
<head>
    <title>PRO LISTE V6.1 - STABLE FAVS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root { --bg: #ffffff; --card: #f8fafc; --accent: #3b82f6; --success: #22c55e; --danger: #ef4444; --text: #1e293b; --shadow: 0 2px 4px rgba(0,0,0,0.1); }
        body { margin: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; color: var(--text); display: flex; flex-direction: column; height: 100vh; overflow: hidden; user-select: none; touch-action: pan-x pan-y; }
        .blur-target { transition: filter 0.3s ease; display: flex; flex-direction: column; height: 100vh; }
        body.modal-open .blur-target { filter: blur(8px); pointer-events: none; }
        
        .top-fixed-bar { background: var(--bg); padding: 10px 15px; border-bottom: 2px solid #e2e8f0; z-index: 100; box-shadow: var(--shadow); }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .left-btns, .right-btns { display: flex; gap: 10px; align-items: center; }
        
        .circle-btn { width: 42px; height: 42px; border-radius: 10px; border: none; font-size: 20px; font-weight: bold; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 3px 5px rgba(0,0,0,0.1); }
        .btn-star { background: #f59e0b; color: white; font-size: 24px; }
        .btn-trash { background: #64748b; font-size: 22px; }
        .btn-plus { background: var(--success); }
        .btn-minus { background: #94a3b8; }
        .btn-bulk { background: var(--accent); font-size: 14px; }

        .container { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; align-items: center; transition: padding-bottom 0.3s ease; }
        .item-card { background: var(--bg); border-radius: 12px; width: 95%; max-width: 500px; min-height: 55px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; box-sizing: border-box; border: 1px solid #e2e8f0; box-shadow: var(--shadow); flex-shrink: 0; }
        .item-card.has-price { background: var(--danger); border-color: var(--danger); }
        .item-card.has-price .item-text, .item-card.has-price .item-price-tag { color: white; }
        .item-text { font-size: 17px; font-weight: 800; text-transform: uppercase; color: var(--text); flex: 1; text-align: left; }
        .item-price-tag { font-size: 16px; font-weight: 900; color: var(--accent); margin-left: 10px; }
        
        .item-card.selected { border: 4px solid var(--danger); position: relative; }
        .item-card.selected::after { content: '‚úï'; position: absolute; right: 10px; color: var(--danger); font-size: 25px; font-weight: 900; }

        .bottom-banner { background: var(--bg); border-top: 3px solid var(--accent); padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.05); }
        #total-value-display { font-size: 26px; font-weight: 900; color: var(--text); }
        .stats-mini { font-size: 13px; font-weight: 800; color: #64748b; text-align: right; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; width: 92%; max-width: 450px; padding: 20px; border-radius: 15px; box-sizing: border-box; position: relative; height: 70vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .modal-content.small-modal { height: auto; }
        .fav-list-area { overflow-y: auto; flex-grow: 1; margin: 10px 0; border: 1px solid #f1f5f9; border-radius: 10px; background: #fafafa; }
        .fav-row { display: flex; align-items: center; padding: 4px; border-bottom: 1px solid #f1f5f9; gap: 12px; font-weight: 800; text-transform: uppercase; color: var(--text); }
        .fav-row input[type="checkbox"] { width: 24px; height: 24px; flex-shrink: 0; }

        input, textarea { width: 100%; padding: 15px; margin: 8px 0; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; box-sizing: border-box; font-size: 16px; font-weight: bold; }
        input:focus { border-color: var(--accent); outline: none; }
        .modal-btns { display: flex; gap: 8px; margin-top: auto; padding-top: 10px; }
        .modal-btns button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; font-size: 15px; }
        .btn-ok { background: var(--accent); color: white; }
        .btn-cancel { background: #e2e8f0; color: #64748b; }

        .floating-confirm { position: fixed; bottom: 30px; left: 0; width: 100%; display: none; justify-content: center; gap: 20px; z-index: 1500; }
        #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; color:var(--accent); font-size: 22px; font-weight:900; }
    </style>
</head>
<body>

<div id="loading-screen">Y√úKLENƒ∞YOR...</div>

<div class="blur-target" id="mainWrapper">
    <div class="top-fixed-bar">
        <div class="header-row">
            <div class="left-btns">
                <div class="circle-btn btn-trash" id="clearListBtn">üóëÔ∏è</div>
                <div class="circle-btn btn-star" id="openFavs">‚≠ê</div>
            </div>
            <div class="right-btns">
                <button class="circle-btn btn-bulk" id="mBulkList">+++</button>
                <button class="circle-btn btn-plus" id="addQuick">+</button>
                <button class="circle-btn btn-minus" id="delQuick">-</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainGrid"></div>

    <div class="bottom-banner">
        <div class="total-box" onclick="openBudgetModal()">
            <div style="font-size: 11px; font-weight: 800; color: #64748b;">TOPLAM TUTAR</div>
            <div id="total-value-display">0.00 TL</div>
        </div>
        <div class="stats-mini">
            <div>TOPLAM √úR√úN</div>
            <div style="font-size: 18px; color: var(--text);" id="total-items-count">0</div>
        </div>
    </div>
</div>

<div class="floating-confirm" id="deleteControls">
    <button class="circle-btn" id="confirmDel" style="background:var(--success); width:65px; height:65px;">‚úì</button>
    <button class="circle-btn" id="cancelDel" style="background:var(--danger); width:65px; height:65px;">‚úï</button>
</div>

<div id="gModal" class="modal">
    <div class="modal-content" id="mContent"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA9whlWMrlyF6GMnWBK7SQA76qNFpO7RkQ",
        authDomain: "market-listesi-d9338.firebaseapp.com",
        projectId: "market-listesi-d9338",
        storageBucket: "market-listesi-d9338.firebasestorage.app",
        messagingSenderId: "91497340883",
        appId: "1:91497340883:web:6e9280b4a70d0a6f38d926",
        databaseURL: "https://market-listesi-d9338-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentList = [];
    let favList = [];
    let userBudget = 0;
    let isReady = false;
    let deleteMode = false;
    let selectedForDelete = new Set();
    let favDeleteMode = false;

    const $ = id => document.getElementById(id);

    db.ref('v5_app_state/current').on('value', snap => {
        const cloud = snap.val();
        if(cloud) { currentList = cloud.data || []; userBudget = cloud.budget || 0; }
        isReady = true; $('loading-screen').style.display = 'none'; render();
    });

    db.ref('v5_app_state/favorites').on('value', snap => { favList = snap.val() || []; });

    function sync() { if(!isReady) return; db.ref('v5_app_state/current').set({id: Date.now(), data: currentList, budget: userBudget}); }
    function syncFavs() { db.ref('v5_app_state/favorites').set(favList); }

    function render() {
        const grid = $('mainGrid'); grid.innerHTML = ''; let total = 0;
        currentList.forEach((item, i) => {
            const card = document.createElement('div');
            card.className = `item-card ${item.price > 0 ? 'has-price' : ''} ${deleteMode && selectedForDelete.has(i) ? 'selected' : ''}`;
            card.innerHTML = `<div class="item-text">${item.name}</div><div class="item-price-tag">${item.price > 0 ? item.price + ' TL' : ''}</div>`;
            card.onclick = () => { if(deleteMode) { if(selectedForDelete.has(i)) selectedForDelete.delete(i); else selectedForDelete.add(i); render(); } else openEditModal(i); };
            grid.appendChild(card); if(item.price > 0) total += parseFloat(item.price);
        });
        $('total-value-display').innerText = total.toFixed(2) + ' TL';
        $('total-items-count').innerText = currentList.length;
    }

    function closeGModal() { $('gModal').style.display='none'; document.body.classList.remove('modal-open'); }

    $('addQuick').onclick = () => {
        document.body.classList.add('modal-open');
        $('mContent').className = "modal-content small-modal";
        $('mContent').innerHTML = `<h3>YENƒ∞ √úR√úN</h3><input type="text" id="inName" placeholder="√úR√úN ADI..." autofocus><div class="modal-btns"><button class="btn-ok" id="btnSaveAdd">EKLE</button><button class="btn-cancel" onclick="closeGModal()">ƒ∞PTAL</button></div>`;
        $('gModal').style.display = 'flex';
        const save = () => { const n = $('inName').value.trim().toUpperCase(); if(n) { currentList.push({name: n, price: 0}); sync(); } closeGModal(); };
        $('btnSaveAdd').onclick = save;
        $('inName').onkeydown = e => { if(e.key === 'Enter') save(); };
    };

    function openEditModal(i) {
        document.body.classList.add('modal-open');
        const item = currentList[i];
        $('mContent').className = "modal-content small-modal";
        $('mContent').innerHTML = `<h3>D√úZENLE</h3><input type="text" id="edName" value="${item.name}"><input type="number" id="edPrice" placeholder="Fƒ∞YAT (TL)" value="${item.price || ''}" autofocus><div class="modal-btns"><button class="btn-ok" id="btnSaveEdit">KAYDET</button><button class="btn-cancel" onclick="closeGModal()">ƒ∞PTAL</button></div>`;
        $('gModal').style.display = 'flex';
        const save = () => { currentList[i].name = $('edName').value.trim().toUpperCase(); currentList[i].price = $('edPrice').value || 0; sync(); closeGModal(); };
        $('btnSaveEdit').onclick = save;
        $('edPrice').onkeydown = e => { if(e.key === 'Enter') save(); };
    }

    function openBudgetModal() {
        document.body.classList.add('modal-open');
        const currentTotal = parseFloat($('total-value-display').innerText);
        $('mContent').className = "modal-content small-modal";
        $('mContent').innerHTML = `<h3>BAKƒ∞YE HESABI</h3><input type="number" id="budgetInput" placeholder="CEBƒ∞NDEKƒ∞ PARA" value="${userBudget || ''}"><div id="resultCalc" style="text-align:center; font-weight:900; font-size:22px; margin:10px 0;"></div><div class="modal-btns"><button class="btn-ok" id="btnSaveBudget">KAYDET</button><button class="btn-cancel" onclick="closeGModal()">KAPAT</button></div>`;
        $('gModal').style.display = 'flex';
        const update = () => { const b = parseFloat($('budgetInput').value) || 0; const k = b - currentTotal; $('resultCalc').innerText = `KALAN: ${k.toFixed(2)} TL`; $('resultCalc').style.color = k < 0 ? 'var(--danger)' : 'var(--success)'; };
        $('budgetInput').oninput = update;
        $('budgetInput').onkeydown = e => { if(e.key === 'Enter') { userBudget = parseFloat($('budgetInput').value) || 0; sync(); closeGModal(); } };
        update();
        $('btnSaveBudget').onclick = () => { userBudget = parseFloat($('budgetInput').value) || 0; sync(); closeGModal(); };
    }

    $('openFavs').onclick = () => { favDeleteMode = false; renderFavModal(); };

    function renderFavModal() {
        document.body.classList.add('modal-open');
        $('mContent').className = "modal-content";
        $('mContent').innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0">FAVORƒ∞LER</h3>
                <div style="display:flex; gap:8px;">
                    <button class="circle-btn btn-plus" id="addFavItem" style="width:40px; height:40px;">+</button>
                    <button class="circle-btn btn-minus" id="toggleFavDel" style="width:40px; height:40px; background:${favDeleteMode?'red':'#94a3b8'}">-</button>
                </div>
            </div>
            <div class="fav-list-area" id="favListItems"></div>
            <div class="modal-btns">
                <button class="btn-ok" id="addSelectedToMain">${favDeleteMode ? 'SE√áƒ∞LENLERƒ∞ Sƒ∞L' : 'ANA Lƒ∞STEYE EKLE'}</button>
                <button class="btn-cancel" onclick="closeGModal()">KAPAT</button>
            </div>`;
        
        const listArea = $('favListItems');
        favList.forEach((fav, idx) => {
            const div = document.createElement('div'); div.className = 'fav-row';
            div.innerHTML = `<input type="checkbox" id="fav_${idx}"> <label for="fav_${idx}" style="flex:1;">${fav}</label>`;
            div.onclick = (e) => { if(e.target.tagName !== 'INPUT') $(`fav_${idx}`).checked = !$(`fav_${idx}`).checked; };
            listArea.appendChild(div);
        });

        $('addFavItem').onclick = openAddFavModal;

        $('toggleFavDel').onclick = () => { favDeleteMode = !favDeleteMode; renderFavModal(); };

        $('addSelectedToMain').onclick = () => {
            const selected = []; favList.forEach((_, idx) => { if($(`fav_${idx}`).checked) selected.push(idx); });
            if(favDeleteMode) { favList = favList.filter((_, idx) => !selected.includes(idx)); syncFavs(); renderFavModal(); } 
            else { selected.forEach(idx => currentList.push({name: favList[idx], price: 0})); sync(); closeGModal(); }
        };
        $('gModal').style.display = 'flex';
    }

    function openAddFavModal() {
        const tempContent = $('mContent').innerHTML;
        const tempClass = $('mContent').className;
        $('mContent').className = "modal-content small-modal";
        $('mContent').innerHTML = `<h3>FAVORƒ∞ EKLE</h3><input type="text" id="newFavName" placeholder="√úR√úN ADI..." autofocus><div class="modal-btns"><button class="btn-ok" id="btnConfirmFav">EKLE</button><button class="btn-cancel" id="btnCancelFav">ƒ∞PTAL</button></div>`;
        const confirm = () => { const n = $('newFavName').value.trim().toUpperCase(); if(n) { favList.push(n); syncFavs(); } $('mContent').className = tempClass; renderFavModal(); };
        $('btnConfirmFav').onclick = confirm;
        $('newFavName').onkeydown = e => { if(e.key === 'Enter') confirm(); };
        $('btnCancelFav').onclick = () => { $('mContent').className = tempClass; renderFavModal(); };
    }

    $('clearListBtn').onclick = () => { if(confirm("Lƒ∞STE TEMƒ∞ZLENSƒ∞N Mƒ∞?")) { currentList = []; sync(); } };

    $('mBulkList').onclick = () => {
        document.body.classList.add('modal-open');
        $('mContent').className = "modal-content";
        const names = currentList.map(x => x.name).join('\n');
        $('mContent').innerHTML = `<h3>TOPLU Lƒ∞STE</h3><textarea id="bulkData" rows="12">${names}</textarea><div class="modal-btns"><button class="btn-ok" id="saveBulk">G√úNCELLE</button><button class="btn-cancel" onclick="closeGModal()">ƒ∞PTAL</button></div>`;
        $('gModal').style.display = 'flex';
        $('saveBulk').onclick = () => { const lines = $('bulkData').value.split('\n'); currentList = lines.map(l => l.trim().toUpperCase()).filter(l => l).map(l => ({name: l, price: 0})); sync(); closeGModal(); };
    };

    $('delQuick').onclick = () => { deleteMode = true; selectedForDelete.clear(); $('deleteControls').style.display = 'flex'; $('mainWrapper').style.opacity = "0.5"; $('mainGrid').style.paddingBottom = "120px"; render(); };
    $('cancelDel').onclick = () => { deleteMode = false; $('deleteControls').style.display = 'none'; $('mainWrapper').style.opacity = "1"; $('mainGrid').style.paddingBottom = "10px"; render(); };
    $('confirmDel').onclick = () => { currentList = currentList.filter((_, i) => !selectedForDelete.has(i)); deleteMode = false; $('deleteControls').style.display = 'none'; $('mainWrapper').style.opacity = "1"; $('mainGrid').style.paddingBottom = "10px"; sync(); };
</script>
</body>
</html>
